version: '3.8'  

services:

  mysql:

    image: mysql:8.0
  
    container_name: dogmatch_mysql

    restart: unless-stopped
    
    env_file:
      - .env
    
    environment:
      
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      
      MYSQL_DATABASE: ${DB_NAME}
      
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    
    volumes:
   
      - mysql_data:/var/lib/mysql
      
    ports:
      - "3306:3306"
   
    healthcheck:

      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p\"$$MYSQL_ROOT_PASSWORD\" || exit 1"]
      interval: 10s     
      timeout: 5s        
      retries: 10        
      start_period: 60s  
  
    networks:
      - dogmatch-network

  
  backend:

    build:
      context: .           
      dockerfile: Dockerfile
    
    container_name: dogmatch_backend
    restart: unless-stopped
    
    env_file:
      - .env
   
    environment:
    
      FLASK_ENV: development  
      FLASK_DEBUG: "true"    
      
      DB_HOST: mysql          
      DB_PORT: 3306
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
     
      DATABASE_URL: mysql+pymysql://${DB_USER}:${DB_PASSWORD}@mysql:3306/${DB_NAME}
      
      GUNICORN_WORKERS: 2
      GUNICORN_THREADS: 2
      
      # Create admin on startup
      CREATE_ADMIN: "true"
    
    # Volumes for development (hot reload!)
    volumes:
     
      - ./app:/app/app:ro         
      - ./migrations:/app/migrations
      
      - logs:/app/logs
      
    ports:
      - "5002:5002"
    
    depends_on:
      mysql:
        condition: service_healthy  
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - dogmatch-network
    
  adminer:

    image: adminer:latest
    
    container_name: dogmatch_adminer
    restart: unless-stopped
    
    ports:
      - "8080:8080"
  
    depends_on:
      - mysql
    
    networks:
      - dogmatch-network
    
    environment:
      ADMINER_DEFAULT_SERVER: mysql
      ADMINER_DESIGN: dracula


networks:
  dogmatch-network:
    driver: bridge  # Standard Docker network driver

volumes:

  mysql_data:
    driver: local
  
  logs:
    driver: local
  
  # Note: No volume for photos - all photos are stored in AWS S3!
  # Database only contains S3 URLs, not actual image files